#!/bin/bash

# These values are for the root CA required by our UI tests. To generate them:
# 1. Open any simulator and reset it
# 2. Drag the rootCA.pem onto the simulator
# 3. Discover the name of the simulator with `xcrun simctl list | grep Booted`
# 4. Connect to the keychain with `sqlite3 /Users/Max.Chuquimia/Library/Developer/CoreSimulator/Devices/SIMULATOR_ID/data/Library/Keychains/TrustStore.sqlite3`
# 5. Read the values of rootCA from the database as hex and paste them below, e.g. `SELECT hex(subj) FROM tsettings;`

SHA1="436B01BAAB1229529C0E43B7C4217A120E51A1A3"
SUBJ="311E301C060355040A13154D4B4345525420444556454C4F504D454E54204341313C303A060355040B0C33416C657373616E64726F2E426F726F6E4049542D43303259443253444A47354A2028416C657373616E64726F20426F726F6E293143304106035504030C3A6D6B6365727420416C657373616E64726F2E426F726F6E4049542D43303259443253444A47354A2028416C657373616E64726F20426F726F6E29"
TSET="3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0A3C21444F435459504520706C697374205055424C494320222D2F2F4170706C652F2F44544420504C49535420312E302F2F454E222022687474703A2F2F7777772E6170706C652E636F6D2F445444732F50726F70657274794C6973742D312E302E647464223E0A3C706C6973742076657273696F6E3D22312E30223E0A3C61727261792F3E0A3C2F706C6973743E0A"
DATA="308205173082037FA00302010202104941D1A0E16537713898AE2A1B5AB2D7300D06092A864886F70D01010B05003081A3311E301C060355040A13156D6B6365727420646576656C6F706D656E74204341313C303A060355040B0C33416C657373616E64726F2E426F726F6E4049542D43303259443253444A47354A2028416C657373616E64726F20426F726F6E293143304106035504030C3A6D6B6365727420416C657373616E64726F2E426F726F6E4049542D43303259443253444A47354A2028416C657373616E64726F20426F726F6E29301E170D3230303632323036323030375A170D3330303632323036323030375A3081A3311E301C060355040A13156D6B6365727420646576656C6F706D656E74204341313C303A060355040B0C33416C657373616E64726F2E426F726F6E4049542D43303259443253444A47354A2028416C657373616E64726F20426F726F6E293143304106035504030C3A6D6B6365727420416C657373616E64726F2E426F726F6E4049542D43303259443253444A47354A2028416C657373616E64726F20426F726F6E29308201A2300D06092A864886F70D01010105000382018F003082018A0282018100C0E2CFC33EC6D9F300A7E84EE903CD071B7C6BE9073A5EA83699943497A2BF52A8836756EBF778858E17F5609C76221AEFFE58B83BEC709EAEEE6EDB5FB55CF19A39D819E2308D870DE7371D7737B6C6B97D4BBC64BD00E978E53D41D31E63AC0D164CBF615A67A7606464BF2C832FEDD151EF10A65221F831730DC4469B749A7C0684F909A266E40D004966DA8F5344A9D81D252FD1B82223092442BC619BF7EBEF5E29406F37F5CB2861545EAF21EC577EB48A7FF91A97C7F43C905DA4D2181EA9C7235B5968A1AF81220B2CE7F31AB385E667AA8C5F1CA20B431D36D30BFA8BFFCFC58305DF3BE4BB1AB95B7E1C30CA982206A9B9C5B2501272BC871313F4A29FF7C9756B77E4F75B8DB5B2CC8970C37BDA6B8383ADE302FA2FB0FB52EDBC5F9AE2B66A98413E5AA99CC45994C0B7B1C704DFFC4A3579B415F38EE51FAF0338E51673E68F181E976B527518A791174909FBBD6F7CB631CD5D50049546A2EBD05B9A30DFE0137F0AB16A10832604B81E8CB78F3C7C48549AC6CA6482DF7BB50203010001A3453043300E0603551D0F0101FF04040302020430120603551D130101FF040830060101FF020100301D0603551D0E0416041406918BB88C02833D16794837F36CE08C37AE0C13300D06092A864886F70D01010B0500038201810031116EDA78D90B03EAA12394830B76A59C67342A7581A8BC63A4CF4A0E1CCD8C43B004FF1392BC7C1760D59EAA992F82A8C30AA19381C7D13390BD0E06AB0940F04E8548C6FE1FBBD82E131FEE33650F50889225FA06E8E76A32D2985EB30A9BFF02A3C6ECBBFD0F8F21BF55C6A3AA7E12B4AC0A1F62F98F4D87423751E910977E3E856448D8317C7B1A3889704402AA09B87BA6E15FC5C1D9A1AD4E986005640088CCECCD51D30967AFD5D7C4DEE1123E845D1DAA3B36A4F9E31CB1C7F80D788030C02CC8227B86CE422E5A378155B5F1AA1660C70C633B90243CA655E5B0DFAE9B951ABB7378AC2317C0B14B558DB0677096A572282C78D6E09A9270DEC86B5EC6D1ECD820EC22A858D02FEDF188B4451FCEC8E603CFD6BE7D7BF0359AB63075B5E575BF9EB47E9287F6D6E4302E504AFA086AF08ADCBD2BFBBD222CFB46BBAA50A8A79571C006827A5C36C765AEF64FEAA1E7633B2E7FADBEDED90E467D01D83A16877BAAFC4B98921AB6C869CEDF2DD120C453F1FF30B8FD1C33A2868AFC"

echo "Installing custom certificate into simulators..."

install() {
if [ -f "$SQLITEDBPATH" ]; then
cp -n "$SQLITEDBPATH" "$SQLITEDBPATH.charlesbackup"
sqlite3 "$SQLITEDBPATH" <<EOF
INSERT INTO "tsettings" VALUES(X'$SHA1',X'$SUBJ',X'$TSET',X'$DATA');
EOF
fi
}

for SQLITEDBPATH in ~/Library/Application\ Support/iPhone\ Simulator/3.*/Library/Keychains/TrustStore.sqlite3
do install
done

for SQLITEDBPATH in ~/Library/Application\ Support/iPhone\ Simulator/4.*/Library/Keychains/TrustStore.sqlite3
do install
done

for SQLITEDBPATH in ~/Library/Developer/CoreSimulator/Devices/*/data/Library/Keychains/TrustStore.sqlite3
do install
done

SQLITEDBPATH=~/Library/Application\ Support/iPhone\ Simulator/User/Library/Keychains/TrustStore.sqlite3
install

echo "Custom certificate has been installed"

# There should be a way to generate the db info from a PEM file - I'm just very unsure about how to extract the subject into the correct format
#PEM_PATH=$1
#SHA1="$(shasum "$PEM_PATH"  | sed 's/^\([a-z0-9]*\) .*$/\1/g' | tr a-z A-Z)"
#SUBJ="???" # openssl asn1parse -in /tmp/data.peopenssl x509 -inform DER -in /private/tmp/data.pem -outform der | openssl asn1parse -inform der -i -strparse 119 -nooutm  -i -strparse 119
#TSET="3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0A3C21444F435459504520706C697374205055424C494320222D2F2F4170706C652F2F44544420504C49535420312E302F2F454E222022687474703A2F2F7777772E6170706C652E636F6D2F445444732F50726F70657274794C6973742D312E302E647464223E0A3C706C6973742076657273696F6E3D22312E30223E0A3C61727261792F3E0A3C2F706C6973743E0A"
#DATA="$(cat "$PEM_PATH" | xxd -p -C -c 999999 | tr a-z A-Z)"

